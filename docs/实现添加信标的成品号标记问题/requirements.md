# 智能保护用户标记的数据合并系统 - Requirements Document

解决Excel数据上传时保护用户手动分类标记的业务逻辑问题，确保用户的分类工作不被新数据覆盖

## 问题背景分析

### 当前痛点
```
场景描述：
Day 1: 用户手动标记 账号A = "成品号"
Day 2: 上传Excel，包含 账号A，但 author_status = null 或 "半成品号"
结果: 用户的"成品号"标记可能被覆盖 ❌
```

### 业务价值
- **保护用户工作成果**: 手动分类需要大量人工判断，具有重要业务价值
- **维持数据一致性**: 避免因系统更新导致的分类丢失
- **提升用户信任**: 系统应该智能地处理数据冲突，而不是简单覆盖

## Core Features

### 1. 冲突检测机制
- **自动检测**: 上传时识别已有用户分类的账号
- **冲突分析**: 统计冲突类型和数量
- **决策提醒**: 向用户展示冲突摘要

### 2. 智能合并策略
- **保护模式** (默认): 保留用户手动分类，只更新统计数据
- **覆盖模式**: 用Excel数据完全替换现有数据
- **交互模式**: 让用户逐项决定冲突处理方式

### 3. 数据溯源追踪
- **分类来源标记**: 区分手动分类 vs 导入分类
- **时间戳记录**: 记录分类和数据的最后更新时间
- **操作日志**: 记录每次合并操作的详细信息

## User Stories

### 核心用户故事
- **作为数据管理员**，我希望上传新Excel时，我之前手动分类的账号状态不会被意外覆盖，这样我就不需要重复分类工作

- **作为数据分析师**，我希望能清楚地知道每个账号的分类来源（手动 vs 导入），这样我就能评估数据的可信度

- **作为系统操作员**，我希望在发生冲突时能够选择处理策略，而不是系统自动做决定，这样我就能根据业务需要灵活处理

### 扩展用户故事  
- **作为质量控制员**，我希望能查看和撤销错误的合并操作，这样我就能纠正意外的数据损失

- **作为团队协作者**，我希望能看到谁在什么时候修改了账号分类，这样团队就能更好地协调工作

## Acceptance Criteria

### 基础功能验收标准
- [ ] **冲突检测**: 系统能准确识别Excel中与现有手动分类冲突的账号
- [ ] **默认保护**: 未明确选择时，系统默认保护用户手动分类
- [ ] **策略选择**: 用户可以在上传时选择合并策略（保护/覆盖/交互）
- [ ] **操作反馈**: 合并完成后显示详细的操作结果报告

### 数据完整性验收标准  
- [ ] **分类保护**: 手动分类的账号在默认模式下不会被覆盖
- [ ] **统计更新**: 保护分类的同时，播放量、点赞数等统计数据正常更新
- [ ] **新账号处理**: Excel中的新账号正常插入，包括其分类信息

### 用户体验验收标准
- [ ] **冲突预览**: 上传前显示冲突摘要："发现12个已分类账号，3个冲突"
- [ ] **操作确认**: 提供清晰的策略选择界面，避免误操作
- [ ] **结果报告**: 显示"保留分类：8个，更新数据：35个，新增账号：5个"

### 审计追踪验收标准
- [ ] **来源标记**: 每个分类都有明确的来源标识（manual/import）
- [ ] **时间追踪**: 记录分类时间和数据更新时间
- [ ] **操作日志**: 记录每次上传的合并决策和影响范围

## 关键决策点分析

### 🤔 需要用户决策的关键问题

#### 1. 冲突优先级策略
```
情况A: Excel有分类 vs 用户已手动分类
- 选项1: 用户分类优先（推荐）
- 选项2: Excel分类优先  
- 选项3: 让用户每次选择
❓ 你倾向于哪种默认行为？
```

#### 2. 时间因素考虑
```
情况B: 如何判断数据的"新旧"？
- 选项1: 以用户分类时间为准
- 选项2: 以Excel文件修改时间为准
- 选项3: 不考虑时间，只看数据来源
❓ 时间因素是否应该影响合并决策？
```

#### 3. 批量操作粒度
```  
情况C: 大量冲突时如何处理？
- 选项1: 全局策略（一键全部保护/覆盖）
- 选项2: 分类策略（按状态类型批量处理）
- 选项3: 逐个确认（每个账号单独决定）
❓ 什么粒度的批量操作最实用？
```

#### 4. 数据库字段设计
```
情况D: 需要添加哪些追踪字段？
- 必要: manual_classified (boolean)
- 可选: classification_source (enum: manual/import/system)
- 可选: classification_time (timestamp) 
- 可选: last_import_time (timestamp)
❓ 哪些字段对业务最重要？
```

#### 5. 用户界面复杂度
```
情况E: 冲突处理界面设计
- 简单版: 只有"保护现有分类" checkbox
- 标准版: 三个选项（保护/覆盖/交互）
- 高级版: 详细的冲突列表和逐项控制
❓ 什么程度的界面复杂度是合适的？
```

## Non-functional Requirements

### 性能要求
- **上传处理时间**: 包含冲突检测的上传不应超过现有上传时间的150%
- **内存使用**: 冲突分析不应显著增加内存消耗
- **并发支持**: 支持多用户同时上传，避免分类冲突

### 兼容性要求  
- **向后兼容**: 现有的Excel格式和上传流程保持不变
- **数据迁移**: 现有数据应能平滑升级到新的追踪机制
- **API兼容**: 现有的账号管理API保持向后兼容

### 安全性要求
- **操作权限**: 只有授权用户能执行覆盖操作
- **审计日志**: 所有分类变更都应被记录
- **数据保护**: 防止意外的批量数据丢失

## 实现思路概述

### 阶段1: 最小可行方案（2-3小时）
1. 添加`manual_classified`字段
2. 修改上传逻辑，默认保护已分类账号
3. 在上传界面添加"覆盖现有分类"选项

### 阶段2: 增强用户体验（1天）
1. 添加冲突检测和预览
2. 提供多种合并策略选择
3. 显示详细的操作结果报告

### 阶段3: 完善追踪机制（1-2天）
1. 添加完整的数据溯源字段
2. 实现操作日志和审计功能
3. 支持操作撤销和历史查看

---

**💡 核心问题**: 在保护用户工作成果和接受新数据之间找到平衡点，需要你在上述决策点中给出业务偏好，这样我们才能设计出符合实际需求的方案。
